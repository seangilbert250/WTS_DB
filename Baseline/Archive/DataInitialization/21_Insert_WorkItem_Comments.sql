USE WTS
GO

CREATE TABLE #WORKITEM_POSTS(
	BUGTRACKER_ID int, BUG_POSTID int, PARENTID int, THREAD_COMMENTID int, BUG_POST_TYPE nvarchar(10)
	, BT_CREATED_USERNAME nvarchar(50), CREATED_FIRST_NAME nvarchar(60), CREATED_LAST_NAME nvarchar(60)
	, BUG_POST_DATE datetime, POST nvarchar(max)
	)
INSERT INTO #WORKITEM_POSTS
	--BT POSTS ASSIGNED TO BT ITEM(ONLY INCLUDE COMMENTS TYPES)
	SELECT
		bp_bug AS BUGTRACKER_ID
		, bp.bp_id AS BUG_POSTID
		, bp.bp_parent AS PARENTID
		, bp.bp_original_comment_id AS THREAD_COMMENTID
		, bp.bp_type AS BUG_POST_TYPE
		, u.us_username AS BT_CREATED_USERNAME
		, u.us_firstname AS CREATED_FIRST_NAME
		, u.us_lastname AS CREATED_LAST_NAME
		, bp.[bp_date] AS BUG_POST_DATE
		, bp.[bp_comment] AS POST
	FROM
		BugTracker.dbo.bug_posts bp
			JOIN BugTracker.dbo.users u ON bp.bp_user = u.us_id
	WHERE
		bp.bp_type = 'comment'
	ORDER BY
		BUGTRACKER_ID, THREAD_COMMENTID, PARENTID, BUG_POSTID
;

--SELECT * FROM #WORKITEM_POSTS;

DELETE FROM WORKITEM_COMMENT;
GO

DELETE FROM [COMMENT];
GO

--insert actual comment records
INSERT INTO [COMMENT](
	BUG_POSTID, COMMENT_TEXT, SORT_ORDER, ARCHIVE, CREATEDBY, CREATEDDATE, UPDATEDBY, UPDATEDDATE
)
SELECT
	BUG_POSTID
	, POST AS COMMENT_TEXT
	, 0 AS SORT_ORDER
	, 0 AS ARCHIVE
	, CREATED_FIRST_NAME + '.' + CREATED_LAST_NAME AS CREATEDBY
	, BUG_POST_DATE AS CREATEDDATE
	, CREATED_FIRST_NAME + '.' + CREATED_LAST_NAME AS UPDATEDBY
	, BUG_POST_DATE AS UPDATEDDATE
FROM
	#WORKITEM_POSTS wp
ORDER BY
	wp.BUG_POSTID
;

SELECT COUNT(*) FROM [COMMENT];

--insert intersect records to attach comments to workitems
INSERT INTO WORKITEM_COMMENT(
	WORKITEMID, COMMENTID, ARCHIVE, CREATEDBY, CREATEDDATE, UPDATEDBY, UPDATEDDATE
)
SELECT
	wi.WORKITEMID
	, c.COMMENTID
	, 0 AS ARCHIVE
	, wp.CREATED_FIRST_NAME + '.' + wp.CREATED_LAST_NAME AS CREATEDBY
	, BUG_POST_DATE AS CREATEDDATE
	, wp.CREATED_FIRST_NAME + '.' + wp.CREATED_LAST_NAME AS UPDATEDBY
	, BUG_POST_DATE AS UPDATEDDATE
FROM
	#WORKITEM_POSTS wp
		JOIN WORKITEM wi ON wp.BUGTRACKER_ID = wi.BUGTRACKER_ID
		JOIN [COMMENT] c ON wp.BUG_POSTID = c.BUG_POSTID
ORDER BY
	wp.BUG_POSTID
;

SELECT COUNT(*) FROM WORKITEM_COMMENT;


DROP TABLE #WORKITEM_POSTS
GO
